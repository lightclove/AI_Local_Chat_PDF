<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥ —Ñ–∞–π–ª–æ–≤ - ChatBot</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
            border-radius: 0;
            overflow: hidden;
            height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #0056b3;
            flex-shrink: 0;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .back-btn {
            background: rgba(255,255,255,0.15);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            transition: all 0.2s ease;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.25);
            transform: translateY(-1px);
        }

        .controls {
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 16px 24px;
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
            flex-shrink: 0;
        }

        .controls select, .controls input {
            padding: 10px 12px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            background: white;
            font-size: 14px;
            min-width: 150px;
        }

        .controls button {
            padding: 10px 16px;
            background: #007bff;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .controls button:hover {
            background: #0056b3;
            transform: translateY(-1px);
        }

        .controls button.refresh {
            background: #28a745;
        }

        .controls button.refresh:hover {
            background: #1e7e34;
        }

        .controls button.clear {
            background: #dc3545;
        }

        .controls button.clear:hover {
            background: #c82333;
        }

        .stats {
            background: #e9ecef;
            padding: 12px 24px;
            border-bottom: 1px solid #dee2e6;
            font-size: 13px;
            color: #495057;
            flex-shrink: 0;
        }

        .log-content {
            flex: 1;
            padding: 0;
            overflow: auto;
            background: #1a1a1a;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Roboto Mono', 'Source Code Pro', monospace;
            font-size: 12px;
            line-height: 1.5;
            color: #f8f9fa;
        }

        .log-wrapper {
            padding: 20px;
            height: 100%;
            overflow: auto;
        }

        .loading {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            font-size: 16px;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 16px 20px;
            border-radius: 6px;
            border: 1px solid #f5c6cb;
            margin: 20px;
            font-size: 14px;
        }

        .log-line {
            padding: 4px 0;
            border-bottom: 1px solid #2d2d2d;
            display: flex;
            align-items: flex-start;
        }

        .log-line:hover {
            background: #2a2a2a;
        }

        .log-timestamp {
            color: #6c757d;
            font-weight: 500;
            min-width: 150px;
            flex-shrink: 0;
        }

        .log-level-DEBUG {
            color: #6c757d;
            font-weight: bold;
        }

        .log-level-INFO {
            color: #17a2b8;
            font-weight: bold;
        }

        .log-level-WARNING {
            color: #ffc107;
            font-weight: bold;
        }

        .log-level-ERROR {
            color: #dc3545;
            font-weight: bold;
        }

        .log-message {
            margin-left: 12px;
            word-break: break-word;
        }

        .traceback {
            background: #2d2d2d;
            border-left: 4px solid #ffc107;
            padding: 12px;
            margin: 8px 0;
            font-family: monospace;
            color: #ffc107;
            border-radius: 0 4px 4px 0;
            overflow-x: auto;
        }

        .traceback-header {
            color: #ffc107;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .traceback-content {
            color: #f8f9fa;
            line-height: 1.4;
        }

        .controls-group {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .controls-group label {
            font-size: 13px;
            color: #495057;
            font-weight: 500;
        }

        .controls-group select, .controls-group input {
            min-width: 120px;
        }

        @media (max-width: 1024px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
                gap: 12px;
            }

            .controls-group {
                justify-content: space-between;
            }

            .controls-group select, .controls-group input {
                min-width: 140px;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 0;
            }

            .container {
                border-radius: 0;
                margin: 0;
            }

            .controls-group {
                flex-direction: column;
                align-items: stretch;
            }

            .controls-group select, .controls-group input {
                min-width: auto;
            }

            .header h1 {
                font-size: 20px;
            }

            .log-content {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üìã –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥ —Ñ–∞–π–ª–æ–≤</h1>
            <a href="/" class="back-btn">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ —á–∞—Ç—É</a>
        </div>

        <div class="controls">
            <div class="controls-group">
                <label for="log-file-select">–§–∞–π–ª:</label>
                <select id="log-file-select">
                    <option value="">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤...</option>
                </select>
            </div>

            <div class="controls-group">
                <label for="log-level-select">–£—Ä–æ–≤–µ–Ω—å:</label>
                <select id="log-level-select">
                    <option value="">–í—Å–µ —É—Ä–æ–≤–Ω–∏</option>
                    <option value="DEBUG">DEBUG</option>
                    <option value="INFO">INFO</option>
                    <option value="WARNING">WARNING</option>
                    <option value="ERROR">ERROR</option>
                </select>
            </div>

            <div class="controls-group">
                <label for="log-lines-input">–°—Ç—Ä–æ–∫–∏:</label>
                <input type="number" id="log-lines-input" value="100" min="10" max="1000">
            </div>

            <button onclick="loadLogs()" class="refresh">üîÑ –û–±–Ω–æ–≤–∏—Ç—å</button>
            <button onclick="clearLogs()" class="clear">üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>

        <div class="stats" id="stats" style="display: none;">
            üìÅ –§–∞–π–ª: <span id="stats-filename"></span> |
            üìä –í—Å–µ–≥–æ —Å—Ç—Ä–æ–∫: <span id="stats-total"></span> |
            üëÅÔ∏è –û—Ç–æ–±—Ä–∞–∂–µ–Ω–æ: <span id="stats-returned"></span> |
            üíæ –†–∞–∑–º–µ—Ä: <span id="stats-size"></span>
        </div>

        <div class="log-content" id="log-content">
            <div class="log-wrapper">
                <div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–≥ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞...</div>
            </div>
        </div>
    </div>

    <script>
        let currentLogs = [];
        let autoRefresh = null;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            loadLogFilesList();
            loadLogs();

            // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            autoRefresh = setInterval(() => {
                if (document.getElementById('log-file-select').value) {
                    loadLogs();
                }
            }, 30000);
        });

        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (autoRefresh) {
                clearInterval(autoRefresh);
            }
        });

        async function loadLogFilesList() {
            try {
                const response = await fetch('/api/logs/files');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                const select = document.getElementById('log-file-select');

                select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–≥ —Ñ–∞–π–ª...</option>';
                data.logs.forEach(log => {
                    const option = document.createElement('option');
                    option.value = log.filename;
                    option.textContent = `${log.filename} (${Math.round(log.size/1024)}KB)`;
                    select.appendChild(option);
                });

                // –í—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π —Ñ–∞–π–ª –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
                if (data.logs.length > 0) {
                    select.value = 'backend.log';
                }

            } catch (e) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤: ' + e.message);
            }
        }

        async function loadLogs() {
            try {
                const filename = document.getElementById('log-file-select').value;
                const level = document.getElementById('log-level-select').value;
                const lines = document.getElementById('log-lines-input').value;

                if (!filename) {
                    showLogs('–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–≥ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞...');
                    return;
                }

                const params = new URLSearchParams();
                params.set('lines', lines);
                if (level) params.set('level', level);

                const response = await fetch(`/api/logs/${filename}?${params}`);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();
                showLogs(data.content || '–õ–æ–≥ —Ñ–∞–π–ª –ø—É—Å—Ç');

                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
                updateStats(data);

            } catch (e) {
                showError('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ' + e.message);
            }
        }

        function showLogs(content) {
            const logWrapper = document.querySelector('.log-wrapper');
            logWrapper.innerHTML = '';

            if (!content || content.trim() === '') {
                logWrapper.innerHTML = '<div class="loading">–õ–æ–≥ —Ñ–∞–π–ª –ø—É—Å—Ç</div>';
                return;
            }

            const lines = content.split('\n');
            let currentTraceback = null;

            lines.forEach((line, index) => {
                if (line.trim()) {
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ –Ω–∞—á–∞–ª–æ–º traceback
                    if (line.includes('Traceback (most recent call last):')) {
                        if (currentTraceback) {
                            logWrapper.appendChild(currentTraceback);
                        }

                        currentTraceback = document.createElement('div');
                        currentTraceback.className = 'traceback';

                        const tracebackContent = document.createElement('div');
                        tracebackContent.className = 'traceback-content';

                        let tracebackLines = [];

                        // –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å traceback
                        for (let i = index; i < lines.length; i++) {
                            const currentLine = lines[i];
                            if (currentLine.trim() && !currentLine.includes('Traceback (most recent call last):')) {
                                tracebackLines.push(currentLine);
                            } else if (i > index && currentLine.trim()) {
                                break; // –ö–æ–Ω–µ—Ü —Ç–µ–∫—É—â–µ–≥–æ traceback
                            }
                        }

                        tracebackContent.textContent = tracebackLines.join('\n');
                        currentTraceback.appendChild(tracebackContent);

                    } else if (currentTraceback) {
                        // –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π traceback
                        const tracebackContent = currentTraceback.querySelector('.traceback-content');
                        tracebackContent.textContent += '\n' + line;
                    } else {
                        // –û–±—ã—á–Ω–∞—è —Å—Ç—Ä–æ–∫–∞ –ª–æ–≥–∞
                        const lineDiv = document.createElement('div');
                        lineDiv.className = 'log-line';

                        // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —É—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
                        let levelClass = '';
                        if (line.includes(' | DEBUG')) levelClass = 'log-level-DEBUG';
                        else if (line.includes(' | INFO')) levelClass = 'log-level-INFO';
                        else if (line.includes(' | WARNING')) levelClass = 'log-level-WARNING';
                        else if (line.includes(' | ERROR')) levelClass = 'log-level-ERROR';

                        lineDiv.innerHTML = `<span class="log-timestamp">${line.substring(0, 23)}</span><span class="log-message"><span class="${levelClass}">${line.substring(24)}</span></span>`;
                        logWrapper.appendChild(lineDiv);
                    }
                }
            });

            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π traceback –µ—Å–ª–∏ –µ—Å—Ç—å
            if (currentTraceback) {
                logWrapper.appendChild(currentTraceback);
            }
        }

        function showError(message) {
            const logWrapper = document.querySelector('.log-wrapper');
            logWrapper.innerHTML = `<div class="error">${message}</div>`;
        }

        function updateStats(data) {
            const statsDiv = document.getElementById('stats');
            const statsFilename = document.getElementById('stats-filename');
            const statsTotal = document.getElementById('stats-total');
            const statsReturned = document.getElementById('stats-returned');
            const statsSize = document.getElementById('stats-size');

            statsFilename.textContent = data.filename;
            statsTotal.textContent = data.total_lines;
            statsReturned.textContent = data.returned_lines;
            statsSize.textContent = `${Math.round(data.size/1024)}KB`;

            statsDiv.style.display = 'block';
        }

        function clearLogs() {
            const logWrapper = document.querySelector('.log-wrapper');
            logWrapper.innerHTML = '<div class="loading">–í—ã–±–µ—Ä–∏—Ç–µ –ª–æ–≥ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞...</div>';
            document.getElementById('stats').style.display = 'none';
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
        document.getElementById('log-file-select').addEventListener('change', loadLogs);
        document.getElementById('log-level-select').addEventListener('change', loadLogs);
        document.getElementById('log-lines-input').addEventListener('change', loadLogs);
    </script>
</body>
</html>
